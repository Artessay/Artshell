\hypertarget{_process_manager_8cpp_source}{}\doxysection{Process\+Manager.\+cpp}
\label{_process_manager_8cpp_source}\index{E:/Artshell/src/ProcessManager.cpp@{E:/Artshell/src/ProcessManager.cpp}}
\mbox{\hyperlink{_process_manager_8cpp}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00001}00001 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{config_8h}{config.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00002}00002 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_console_8h}{Console.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00003}00003 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_binary_heap_8h}{BinaryHeap.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00004}00004 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_process_manager_8h}{ProcessManager.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00005}00005 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00006}00006 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00007}00007 \textcolor{preprocessor}{\#include <string.h>}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00008}00008 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00009}00009 \textcolor{preprocessor}{\#include <sys/wait.h>}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00010}00010 \textcolor{preprocessor}{\#include <sys/types.h>}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00011}00011 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00012}\mbox{\hyperlink{classjob__unit_aacc38b1925b21776d7af72be9998499a}{00012}} \mbox{\hyperlink{classjob__unit_aacc38b1925b21776d7af72be9998499a}{job\_unit::job\_unit}}(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \_id, \textcolor{keywordtype}{int} \_pid, \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592}{job\_state}} \_state, \textcolor{keywordtype}{int} \_argc, \textcolor{keywordtype}{char} * \_argv[])}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00013}00013             : id(\_id), pid(\_pid), state(\_state), argc(\_argc)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00014}00014 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00015}00015     \textcolor{comment}{// argv 必须进行深拷贝，否则释放argv后将不再有，还会造成段错误}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00016}00016     assert(\mbox{\hyperlink{classjob__unit_a6acc693f8b4fbd2d277b26a364132684}{argc}} < \mbox{\hyperlink{lexer_8l_a499bb30c08bb531d8f38308696a110c1}{MAX\_ARGUMENT\_NUMBER}});}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00017}00017     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < \mbox{\hyperlink{classjob__unit_a6acc693f8b4fbd2d277b26a364132684}{argc}}; ++i)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00018}00018         strncpy(\mbox{\hyperlink{classjob__unit_ac0479d1e80912a0997948b98a6047704}{argv}}[i], \_argv[i], \mbox{\hyperlink{config_8h_adf261954779e694ad997533c5da9ad5a}{BUFFER\_SIZE}});}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00019}00019 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00020}00020 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00021}\mbox{\hyperlink{classjob__unit_a78f5ab99ea4816004faf381068851a8f}{00021}} \textcolor{keywordtype}{void} \mbox{\hyperlink{classjob__unit_a78f5ab99ea4816004faf381068851a8f}{job\_unit::PrintJob}}(\textcolor{keywordtype}{int} output\_fd)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00022}00022 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00023}00023     \textcolor{comment}{// if (argc <= 0)  // 参数错误}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00024}00024     \textcolor{comment}{// \{}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00025}00025     \textcolor{comment}{//     assert(false \&\& "{}argument error"{});}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00026}00026     \textcolor{comment}{//     return;}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00027}00027     \textcolor{comment}{// \}}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00028}00028 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00029}00029     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *State\_;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00030}00030     \textcolor{keywordflow}{switch} (\mbox{\hyperlink{classjob__unit_a5f5711cec4b003ddad03bd47d73db92e}{state}})  \textcolor{comment}{// 状态映射}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00031}00031     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00032}00032         \textcolor{keywordflow}{case} \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592a2f5f2c4a8c4f4f0519d503dcdfbf55cb}{Running}}:                                    \textcolor{comment}{// 正在运行}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00033}00033             State\_ = \textcolor{stringliteral}{"{}Running"{}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00034}00034             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00035}00035         \textcolor{keywordflow}{case} \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592a4d049c6d45e08a294523df186ad77a75}{Stopped}}:                                    \textcolor{comment}{// 停止运行}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00036}00036             State\_ = \textcolor{stringliteral}{"{}Stopped"{}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00037}00037             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00038}00038         \textcolor{keywordflow}{case} \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592aa7929b884d7db9093d6ed453feedf2a2}{Done}}:                                       \textcolor{comment}{// 完成运行}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00039}00039             State\_ = \textcolor{stringliteral}{"{}Done"{}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00040}00040             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00041}00041         \textcolor{keywordflow}{case} \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592a0bd9962868a464e4730ffcf8d3fa798d}{Terminated}}:                                 \textcolor{comment}{// 终止运行}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00042}00042             State\_ = \textcolor{stringliteral}{"{}Terminated"{}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00043}00043             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00044}00044     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00045}00045 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00046}00046     \textcolor{comment}{// 状态打印}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00047}00047     \textcolor{keywordtype}{char} buffer[\mbox{\hyperlink{config_8h_adf261954779e694ad997533c5da9ad5a}{BUFFER\_SIZE}}];}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00048}00048     ssize\_t write\_state;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00049}00049     snprintf(buffer, \mbox{\hyperlink{config_8h_adf261954779e694ad997533c5da9ad5a}{BUFFER\_SIZE}}-\/1, \textcolor{stringliteral}{"{}[\%u]\%c\(\backslash\)t\%s\(\backslash\)t\(\backslash\)t\(\backslash\)t\(\backslash\)t\(\backslash\)t"{}}, \textcolor{keywordtype}{id}, \textcolor{charliteral}{' '}, State\_);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00050}00050     write\_state = write(output\_fd, buffer, strlen(buffer));}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00051}00051     \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00052}00052         \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00053}00053 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00054}00054     \textcolor{comment}{// 参数打印}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00055}00055     \textcolor{keywordflow}{if} (\mbox{\hyperlink{classjob__unit_a6acc693f8b4fbd2d277b26a364132684}{argc}} > 0)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00056}00056     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00057}00057         write\_state = write(output\_fd, \mbox{\hyperlink{classjob__unit_ac0479d1e80912a0997948b98a6047704}{argv}}[0], strlen(\mbox{\hyperlink{classjob__unit_ac0479d1e80912a0997948b98a6047704}{argv}}[0])); \textcolor{comment}{// 确保行末无多余的空格}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00058}00058         \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00059}00059             \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00060}00060         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 1; i < \mbox{\hyperlink{classjob__unit_a6acc693f8b4fbd2d277b26a364132684}{argc}}; ++i)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00061}00061         \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00062}00062             write\_state = write(output\_fd, \textcolor{stringliteral}{"{} "{}}, 1);   \textcolor{comment}{// 打印空格}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00063}00063             \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00064}00064                 \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00065}00065 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00066}00066             write\_state = write(output\_fd, \mbox{\hyperlink{classjob__unit_ac0479d1e80912a0997948b98a6047704}{argv}}[i], strlen(\mbox{\hyperlink{classjob__unit_ac0479d1e80912a0997948b98a6047704}{argv}}[i])); \textcolor{comment}{// 打印参数}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00067}00067             \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00068}00068                 \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00069}00069         \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00070}00070     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00071}00071     }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00072}00072     write\_state = write(output\_fd, \textcolor{stringliteral}{"{}\(\backslash\)n"{}}, 1);   \textcolor{comment}{// 打印换行符}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00073}00073     \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00074}00074         \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00075}00075 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00076}00076 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00077}\mbox{\hyperlink{class_process_manager_a41b83a8ef0a801ca3aee9a3d82568ac1}{00077}} \mbox{\hyperlink{class_process_manager_a41b83a8ef0a801ca3aee9a3d82568ac1}{ProcessManager::ProcessManager}}(\textcolor{comment}{/* args */})}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00078}00078 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00079}00079     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} job\_id[\mbox{\hyperlink{config_8h_af25022a50eb39b13884d848c102c0b5b}{MAX\_PROCESS\_NUMBER}}];}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00080}00080     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 1; i <= \mbox{\hyperlink{config_8h_af25022a50eb39b13884d848c102c0b5b}{MAX\_PROCESS\_NUMBER}}; ++i)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00081}00081         job\_id[i-\/1] = i;        \textcolor{comment}{// 初始化工作进程id池}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00082}00082     \mbox{\hyperlink{class_process_manager_a36a9c5285474e8be29078f3f7512c50f}{job\_heap}} = \textcolor{keyword}{new} \mbox{\hyperlink{class_binary_heap}{BinaryHeap<unsigned int>}}(job\_id, \mbox{\hyperlink{config_8h_af25022a50eb39b13884d848c102c0b5b}{MAX\_PROCESS\_NUMBER}});}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00083}00083     }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00084}00084 \textcolor{preprocessor}{    \#ifdef \_DEBUG\_}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00085}00085     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 1; i <= \mbox{\hyperlink{config_8h_af25022a50eb39b13884d848c102c0b5b}{MAX\_PROCESS\_NUMBER}}; ++i)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00086}00086         printf(\textcolor{stringliteral}{"{}heap: \%u\(\backslash\)n"{}}, \mbox{\hyperlink{class_process_manager_a36a9c5285474e8be29078f3f7512c50f}{job\_heap}}-\/>\mbox{\hyperlink{class_heap_a939b7f03924d3901e8bebfdaadfd9513}{extract}}());}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00087}00087 \textcolor{preprocessor}{    \#endif}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00088}00088 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00089}00089 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00090}\mbox{\hyperlink{class_process_manager_aed3cd2ca11d92395228b758d39030b5f}{00090}} \mbox{\hyperlink{class_process_manager_aed3cd2ca11d92395228b758d39030b5f}{ProcessManager::\string~ProcessManager}}()}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00091}00091 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00092}00092     \textcolor{keyword}{delete} \mbox{\hyperlink{class_process_manager_a36a9c5285474e8be29078f3f7512c50f}{job\_heap}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00093}00093 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00094}00094 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00095}\mbox{\hyperlink{class_process_manager_aed9ebd7ba0bc7e16c0a5df542900ab45}{00095}} \textcolor{keywordtype}{void} \mbox{\hyperlink{class_process_manager_aed9ebd7ba0bc7e16c0a5df542900ab45}{ProcessManager::PrintJobList}}(\textcolor{keywordtype}{int} output\_fd)\textcolor{keyword}{ const}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00096}00096 \textcolor{keyword}{}\{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00097}00097     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}})}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00098}00098     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00099}00099         job.PrintJob(output\_fd);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00100}00100     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00101}00101 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00102}00102 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00103}\mbox{\hyperlink{class_process_manager_ade7e167c72e4090133356c01e7c6f19b}{00103}} \textcolor{keywordtype}{void} \mbox{\hyperlink{class_process_manager_ade7e167c72e4090133356c01e7c6f19b}{ProcessManager::PrintJobListDone}}(\textcolor{keywordtype}{int} output\_fd)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00104}00104 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00105}00105     \mbox{\hyperlink{classjob__unit}{job\_unit}} *pre\_job = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00106}00106     }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00107}00107     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}})}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00108}00108     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00109}00109 \textcolor{preprocessor}{        \#ifdef \_DEBUG\_}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00110}00110         printf(\textcolor{stringliteral}{"{}Id: \%u pid: \%d\(\backslash\)n"{}}, job.id, job.pid);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00111}00111 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00112}00112         \textcolor{keywordflow}{if} (pre\_job != \textcolor{keyword}{nullptr})     \textcolor{comment}{// 内存回收}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00113}00113         \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00114}00114             this-\/>\mbox{\hyperlink{class_process_manager_abb124eed9ed603f5de81438f94c2e342}{JobRemove}}(pre\_job);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00115}00115             pre\_job = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00116}00116         \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00117}00117 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00118}00118         \textcolor{comment}{/* waitpid 在WNOHANG参数下 如果子进程已经结束，则返回子进程的pid；}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00119}00119 \textcolor{comment}{        如果子进程还未结束，则返回0； 如果发生错误，则返回-\/1 */}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00120}00120         \textcolor{keywordtype}{int} stat\_loc, wait\_pid = waitpid(job.pid, \&stat\_loc, WNOHANG);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00121}00121 \textcolor{preprocessor}{        \#ifdef \_DEBUG\_}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00122}00122         printf(\textcolor{stringliteral}{"{}id: \%u pid: \%d wait: \%d stat: \%d\(\backslash\)n"{}}, job.id, job.pid, wait\_pid, stat\_loc);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00123}00123 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00124}00124         \textcolor{keywordflow}{if} (wait\_pid == job.pid) \textcolor{comment}{// 已经结束}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00125}00125         \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00126}00126             job.state = \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592aa7929b884d7db9093d6ed453feedf2a2}{Done}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00127}00127             job.PrintJob();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00128}00128             pre\_job = \&job;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00129}00129         \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00130}00130         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (wait\_pid < 0)  \textcolor{comment}{// 发生错误}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00131}00131         \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00132}00132             \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00133}00133         \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00134}00134     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00135}00135 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00136}00136     \textcolor{keywordflow}{if} (pre\_job != \textcolor{keyword}{nullptr})     \textcolor{comment}{// 内存回收}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00137}00137         this-\/>\mbox{\hyperlink{class_process_manager_abb124eed9ed603f5de81438f94c2e342}{JobRemove}}(pre\_job);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00138}00138 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00139}00139 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00140}\mbox{\hyperlink{class_process_manager_a165280bdbc9eb678b83f3340fde4c9ca}{00140}} \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \mbox{\hyperlink{class_process_manager_a165280bdbc9eb678b83f3340fde4c9ca}{ProcessManager::JobInsert}}(\textcolor{keywordtype}{int} pid, \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592}{job\_state}} state, \textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[])}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00141}00141 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00142}00142     \textcolor{keywordflow}{try}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00143}00143     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00144}00144         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \textcolor{keywordtype}{id} = \mbox{\hyperlink{class_process_manager_a36a9c5285474e8be29078f3f7512c50f}{job\_heap}}-\/>\mbox{\hyperlink{class_heap_a939b7f03924d3901e8bebfdaadfd9513}{extract}}();  \textcolor{comment}{// 从id池取出最小的id}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00145}00145         \mbox{\hyperlink{classjob__unit}{job\_unit}}* newJob = \textcolor{keyword}{new} \mbox{\hyperlink{classjob__unit}{job\_unit}}(\textcolor{keywordtype}{id}, pid, state, argc, argv);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00146}00146 \textcolor{preprocessor}{        \#ifdef \_DEBUG\_}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00147}00147         newJob-\/>\mbox{\hyperlink{classjob__unit_a78f5ab99ea4816004faf381068851a8f}{PrintJob}}();}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00148}00148 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00149}00149         \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}}.emplace(*newJob);   \textcolor{comment}{// 加入集合}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00150}00150         \textcolor{keywordflow}{return} id;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00151}00151     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00152}00152     \textcolor{keywordflow}{catch} (std::exception\& e)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00153}00153     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00154}00154         std::cerr << e.what() << \textcolor{charliteral}{'\(\backslash\)n'};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00155}00155         \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00156}00156     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00157}00157 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00158}00158 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00159}\mbox{\hyperlink{class_process_manager_abb124eed9ed603f5de81438f94c2e342}{00159}} \textcolor{keywordtype}{void} \mbox{\hyperlink{class_process_manager_abb124eed9ed603f5de81438f94c2e342}{ProcessManager::JobRemove}}(\mbox{\hyperlink{classjob__unit}{job\_unit}} * job)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00160}00160 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00161}00161     assert(job-\/>\mbox{\hyperlink{classjob__unit_a376668024dff325871b84fe74d0240ee}{id}} > 0);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00162}00162     \mbox{\hyperlink{class_process_manager_a36a9c5285474e8be29078f3f7512c50f}{job\_heap}}-\/>\mbox{\hyperlink{class_heap_a412ca53eb7bc9124283e17207da9beb6}{insert}}(job-\/>\mbox{\hyperlink{classjob__unit_a376668024dff325871b84fe74d0240ee}{id}});  \textcolor{comment}{// 将id放回id池中}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00163}00163     \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}}.erase(*job);            \textcolor{comment}{// 移出集合}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00164}00164     \textcolor{comment}{// delete job;  // 因为在set里面存放的不是指针了，在erase set的时候已经完成了析构}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00165}00165     \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00166}00166 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00167}00167 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00168}\mbox{\hyperlink{class_process_manager_aff12fe01667b1eb668d90092afba170d}{00168}} \textcolor{keywordtype}{void} \mbox{\hyperlink{class_process_manager_abb124eed9ed603f5de81438f94c2e342}{ProcessManager::JobRemove}}(std::set<job\_unit>::iterator\& job)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00169}00169 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00170}00170     \mbox{\hyperlink{class_process_manager_a36a9c5285474e8be29078f3f7512c50f}{job\_heap}}-\/>\mbox{\hyperlink{class_heap_a412ca53eb7bc9124283e17207da9beb6}{insert}}(job-\/>id);  \textcolor{comment}{// 将id放回id池中}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00171}00171     \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}}.erase(*job);            \textcolor{comment}{// 移出集合}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00172}00172     \textcolor{comment}{// delete job;  // 因为在set里面存放的不是指针了，在erase set的时候已经完成了析构}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00173}00173     \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00174}00174 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00175}00175 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00176}\mbox{\hyperlink{class_process_manager_ac3e1dc05eb4aeb4080b3d16ef5ff36b6}{00176}} \textcolor{keywordtype}{int} \mbox{\hyperlink{class_process_manager_ac3e1dc05eb4aeb4080b3d16ef5ff36b6}{ProcessManager::ForeGround}}(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} jobid)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00177}00177 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00178}00178     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}})}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00179}00179     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00180}00180         \textcolor{keywordflow}{if} (job.id == jobid)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00181}00181         \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00182}00182             \mbox{\hyperlink{class_console_a3c25c3e25d382763b01052cf292f6621}{Console::child\_process\_id}} = job.pid;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00183}00183             setpgid(job.pid, getgid());}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00184}00184 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00185}00185             \textcolor{comment}{// 将前端设置为子进程}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00186}00186             tcsetpgrp(STDIN\_FILENO, job.pid);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00187}00187             tcsetpgrp(STDOUT\_FILENO, job.pid);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00188}00188             tcsetpgrp(STDERR\_FILENO, job.pid);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00189}00189             job.state = \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592a2f5f2c4a8c4f4f0519d503dcdfbf55cb}{Running}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00190}00190 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00191}00191             kill(job.pid, SIGCONT);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00192}00192             \textcolor{keywordflow}{while}(waitpid(\mbox{\hyperlink{class_console_a3c25c3e25d382763b01052cf292f6621}{Console::child\_process\_id}}, NULL, WNOHANG) == 0 \&\& \mbox{\hyperlink{class_console_a3c25c3e25d382763b01052cf292f6621}{Console::child\_process\_id}} >= 0);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00193}00193             \mbox{\hyperlink{class_console_a3c25c3e25d382763b01052cf292f6621}{Console::child\_process\_id}} = -\/1;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00194}00194 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00195}00195             \mbox{\hyperlink{class_process_manager_abb124eed9ed603f5de81438f94c2e342}{JobRemove}}(\&job);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00196}00196 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00197}00197             \textcolor{keywordflow}{return} jobid;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00198}00198         \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00199}00199     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00200}00200 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00201}00201     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00202}00202 \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00203}00203 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00204}00204 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00205}\mbox{\hyperlink{class_process_manager_a5497e2786bfea99f905ca8951abb36f8}{00205}} \textcolor{keywordtype}{int} \mbox{\hyperlink{class_process_manager_a5497e2786bfea99f905ca8951abb36f8}{ProcessManager::BackGround}}(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} jobid)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00206}00206 \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00207}00207     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : \mbox{\hyperlink{class_process_manager_a47c6f4814d62cb824924a5f819a0fb67}{jobs}})}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00208}00208     \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00209}00209         \textcolor{keywordflow}{if} (job.id == jobid)}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00210}00210         \{}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00211}00211             \textcolor{keywordflow}{if} (job.state == \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592a2f5f2c4a8c4f4f0519d503dcdfbf55cb}{Running}})}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00212}00212                 \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00213}00213             }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00214}00214             job.state = \mbox{\hyperlink{config_8h_a97622948346be03d21f97b3c562b9592a2f5f2c4a8c4f4f0519d503dcdfbf55cb}{Running}};}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00215}00215 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00216}00216             kill(job.pid, SIGCONT);}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00217}00217             }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00218}00218             \textcolor{keywordflow}{return} jobid;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00219}00219         \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00220}00220     \}}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00221}00221 }
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00222}00222     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{\Hypertarget{_process_manager_8cpp_source_l00223}00223 \}}

\end{DoxyCode}
