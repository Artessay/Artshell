\doxysection{Process\+Manager.\+cpp}
\label{_process_manager_8cpp_source}\index{src/ProcessManager.cpp@{src/ProcessManager.cpp}}
\textbf{ 浏览该文件的文档.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001 \textcolor{preprocessor}{\#include "{}config.h"{}}}
\DoxyCodeLine{00002 \textcolor{preprocessor}{\#include "{}Console.h"{}}}
\DoxyCodeLine{00003 \textcolor{preprocessor}{\#include "{}BinaryHeap.h"{}}}
\DoxyCodeLine{00004 \textcolor{preprocessor}{\#include "{}ProcessManager.h"{}}}
\DoxyCodeLine{00005 }
\DoxyCodeLine{00006 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{00007 \textcolor{preprocessor}{\#include <string.h>}}
\DoxyCodeLine{00008 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{00009 \textcolor{preprocessor}{\#include <sys/wait.h>}}
\DoxyCodeLine{00010 \textcolor{preprocessor}{\#include <sys/types.h>}}
\DoxyCodeLine{00011 }
\DoxyCodeLine{00012 job\_unit::job\_unit(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \_id, \textcolor{keywordtype}{int} \_pid, job\_state \_state, \textcolor{keywordtype}{int} \_argc, \textcolor{keywordtype}{char} * \_argv[])}
\DoxyCodeLine{00013             : id(\_id), pid(\_pid), state(\_state), argc(\_argc)}
\DoxyCodeLine{00014 \{}
\DoxyCodeLine{00015     \textcolor{comment}{// argv 必须进行深拷贝，否则释放argv后将不再有，还会造成段错误}}
\DoxyCodeLine{00016     assert(argc < MAX\_ARGUMENT\_NUMBER);}
\DoxyCodeLine{00017     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < argc; ++i)}
\DoxyCodeLine{00018         strncpy(argv[i], \_argv[i], BUFFER\_SIZE);}
\DoxyCodeLine{00019 \}}
\DoxyCodeLine{00020 }
\DoxyCodeLine{00021 \textcolor{keywordtype}{void} job\_unit::PrintJob(\textcolor{keywordtype}{int} output\_fd)}
\DoxyCodeLine{00022 \{}
\DoxyCodeLine{00023     \textcolor{comment}{// if (argc <= 0)  // 参数错误}}
\DoxyCodeLine{00024     \textcolor{comment}{// \{}}
\DoxyCodeLine{00025     \textcolor{comment}{//     assert(false \&\& "{}argument error"{});}}
\DoxyCodeLine{00026     \textcolor{comment}{//     return;}}
\DoxyCodeLine{00027     \textcolor{comment}{// \}}}
\DoxyCodeLine{00028 }
\DoxyCodeLine{00029     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *State\_;}
\DoxyCodeLine{00030     \textcolor{keywordflow}{switch} (state)  \textcolor{comment}{// 状态映射}}
\DoxyCodeLine{00031     \{}
\DoxyCodeLine{00032         \textcolor{keywordflow}{case} Running:                                    \textcolor{comment}{// 正在运行}}
\DoxyCodeLine{00033             State\_ = \textcolor{stringliteral}{"{}Running"{}};}
\DoxyCodeLine{00034             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00035         \textcolor{keywordflow}{case} Stopped:                                    \textcolor{comment}{// 停止运行}}
\DoxyCodeLine{00036             State\_ = \textcolor{stringliteral}{"{}Stopped"{}};}
\DoxyCodeLine{00037             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00038         \textcolor{keywordflow}{case} Done:                                       \textcolor{comment}{// 完成运行}}
\DoxyCodeLine{00039             State\_ = \textcolor{stringliteral}{"{}Done"{}};}
\DoxyCodeLine{00040             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00041         \textcolor{keywordflow}{case} Terminated:                                 \textcolor{comment}{// 终止运行}}
\DoxyCodeLine{00042             State\_ = \textcolor{stringliteral}{"{}Terminated"{}};}
\DoxyCodeLine{00043             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00044     \}}
\DoxyCodeLine{00045 }
\DoxyCodeLine{00046     \textcolor{comment}{// 状态打印}}
\DoxyCodeLine{00047     \textcolor{keywordtype}{char} buffer[BUFFER\_SIZE];}
\DoxyCodeLine{00048     ssize\_t write\_state;}
\DoxyCodeLine{00049     snprintf(buffer, BUFFER\_SIZE-\/1, \textcolor{stringliteral}{"{}[\%u]\%c\(\backslash\)t\%s\(\backslash\)t\(\backslash\)t\(\backslash\)t\(\backslash\)t\(\backslash\)t"{}}, \textcolor{keywordtype}{id}, \textcolor{charliteral}{' '}, State\_);}
\DoxyCodeLine{00050     write\_state = write(output\_fd, buffer, strlen(buffer));}
\DoxyCodeLine{00051     \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{00052         \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00053 }
\DoxyCodeLine{00054     \textcolor{comment}{// 参数打印}}
\DoxyCodeLine{00055     \textcolor{keywordflow}{if} (argc > 0)}
\DoxyCodeLine{00056     \{}
\DoxyCodeLine{00057         write\_state = write(output\_fd, argv[0], strlen(argv[0])); \textcolor{comment}{// 确保行末无多余的空格}}
\DoxyCodeLine{00058         \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{00059             \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00060         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 1; i < argc; ++i)}
\DoxyCodeLine{00061         \{}
\DoxyCodeLine{00062             write\_state = write(output\_fd, \textcolor{stringliteral}{"{} "{}}, 1);   \textcolor{comment}{// 打印空格}}
\DoxyCodeLine{00063             \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{00064                 \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00065 }
\DoxyCodeLine{00066             write\_state = write(output\_fd, argv[i], strlen(argv[i])); \textcolor{comment}{// 打印参数}}
\DoxyCodeLine{00067             \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{00068                 \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00069         \}}
\DoxyCodeLine{00070     \}}
\DoxyCodeLine{00071     }
\DoxyCodeLine{00072     write\_state = write(output\_fd, \textcolor{stringliteral}{"{}\(\backslash\)n"{}}, 1);   \textcolor{comment}{// 打印换行符}}
\DoxyCodeLine{00073     \textcolor{keywordflow}{if} (write\_state == -\/1)}
\DoxyCodeLine{00074         \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00075 \}}
\DoxyCodeLine{00076 }
\DoxyCodeLine{00077 ProcessManager::ProcessManager(\textcolor{comment}{/* args */})}
\DoxyCodeLine{00078 \{}
\DoxyCodeLine{00079     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} job\_id[MAX\_PROCESS\_NUMBER];}
\DoxyCodeLine{00080     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 1; i <= MAX\_PROCESS\_NUMBER; ++i)}
\DoxyCodeLine{00081         job\_id[i-\/1] = i;        \textcolor{comment}{// 初始化工作进程id池}}
\DoxyCodeLine{00082     job\_heap = \textcolor{keyword}{new} BinaryHeap<unsigned int>(job\_id, MAX\_PROCESS\_NUMBER);}
\DoxyCodeLine{00083     }
\DoxyCodeLine{00084 \textcolor{preprocessor}{    \#ifdef \_DEBUG\_}}
\DoxyCodeLine{00085     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 1; i <= MAX\_PROCESS\_NUMBER; ++i)}
\DoxyCodeLine{00086         printf(\textcolor{stringliteral}{"{}heap: \%u\(\backslash\)n"{}}, job\_heap-\/>extract());}
\DoxyCodeLine{00087 \textcolor{preprocessor}{    \#endif}}
\DoxyCodeLine{00088 \}}
\DoxyCodeLine{00089 }
\DoxyCodeLine{00090 ProcessManager::\string~ProcessManager()}
\DoxyCodeLine{00091 \{}
\DoxyCodeLine{00092     \textcolor{keyword}{delete} job\_heap;}
\DoxyCodeLine{00093 \}}
\DoxyCodeLine{00094 }
\DoxyCodeLine{00095 \textcolor{keywordtype}{void} ProcessManager::PrintJobList(\textcolor{keywordtype}{int} output\_fd)\textcolor{keyword}{ const}}
\DoxyCodeLine{00096 \textcolor{keyword}{}\{}
\DoxyCodeLine{00097     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : jobs)}
\DoxyCodeLine{00098     \{}
\DoxyCodeLine{00099         job.PrintJob(output\_fd);}
\DoxyCodeLine{00100     \}}
\DoxyCodeLine{00101 \}}
\DoxyCodeLine{00102 }
\DoxyCodeLine{00103 \textcolor{keywordtype}{void} ProcessManager::PrintJobListDone(\textcolor{keywordtype}{int} output\_fd)}
\DoxyCodeLine{00104 \{}
\DoxyCodeLine{00105     job\_unit *pre\_job = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00106     }
\DoxyCodeLine{00107     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : jobs)}
\DoxyCodeLine{00108     \{}
\DoxyCodeLine{00109 \textcolor{preprocessor}{        \#ifdef \_DEBUG\_}}
\DoxyCodeLine{00110         printf(\textcolor{stringliteral}{"{}Id: \%u pid: \%d\(\backslash\)n"{}}, job.id, job.pid);}
\DoxyCodeLine{00111 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{00112         \textcolor{keywordflow}{if} (pre\_job != \textcolor{keyword}{nullptr})     \textcolor{comment}{// 内存回收}}
\DoxyCodeLine{00113         \{}
\DoxyCodeLine{00114             this-\/>JobRemove(pre\_job);}
\DoxyCodeLine{00115             pre\_job = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00116         \}}
\DoxyCodeLine{00117 }
\DoxyCodeLine{00118         \textcolor{comment}{/* waitpid 在WNOHANG参数下 如果子进程已经结束，则返回子进程的pid；}}
\DoxyCodeLine{00119 \textcolor{comment}{        如果子进程还未结束，则返回0； 如果发生错误，则返回-\/1 */}}
\DoxyCodeLine{00120         \textcolor{keywordtype}{int} stat\_loc, wait\_pid = waitpid(job.pid, \&stat\_loc, WNOHANG);}
\DoxyCodeLine{00121 \textcolor{preprocessor}{        \#ifdef \_DEBUG\_}}
\DoxyCodeLine{00122         printf(\textcolor{stringliteral}{"{}id: \%u pid: \%d wait: \%d stat: \%d\(\backslash\)n"{}}, job.id, job.pid, wait\_pid, stat\_loc);}
\DoxyCodeLine{00123 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{00124         \textcolor{keywordflow}{if} (wait\_pid == job.pid) \textcolor{comment}{// 已经结束}}
\DoxyCodeLine{00125         \{}
\DoxyCodeLine{00126             job.state = Done;}
\DoxyCodeLine{00127             job.PrintJob();}
\DoxyCodeLine{00128             pre\_job = \&job;}
\DoxyCodeLine{00129         \}}
\DoxyCodeLine{00130         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (wait\_pid < 0)  \textcolor{comment}{// 发生错误}}
\DoxyCodeLine{00131         \{}
\DoxyCodeLine{00132             \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00133         \}}
\DoxyCodeLine{00134     \}}
\DoxyCodeLine{00135 }
\DoxyCodeLine{00136     \textcolor{keywordflow}{if} (pre\_job != \textcolor{keyword}{nullptr})     \textcolor{comment}{// 内存回收}}
\DoxyCodeLine{00137         this-\/>JobRemove(pre\_job);}
\DoxyCodeLine{00138 \}}
\DoxyCodeLine{00139 }
\DoxyCodeLine{00140 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} ProcessManager::JobInsert(\textcolor{keywordtype}{int} pid, job\_state state, \textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[])}
\DoxyCodeLine{00141 \{}
\DoxyCodeLine{00142     \textcolor{keywordflow}{try}}
\DoxyCodeLine{00143     \{}
\DoxyCodeLine{00144         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \textcolor{keywordtype}{id} = job\_heap-\/>extract();  \textcolor{comment}{// 从id池取出最小的id}}
\DoxyCodeLine{00145         job\_unit* newJob = \textcolor{keyword}{new} job\_unit(\textcolor{keywordtype}{id}, pid, state, argc, argv);}
\DoxyCodeLine{00146 \textcolor{preprocessor}{        \#ifdef \_DEBUG\_}}
\DoxyCodeLine{00147         newJob-\/>PrintJob();}
\DoxyCodeLine{00148 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{00149         jobs.emplace(*newJob);   \textcolor{comment}{// 加入集合}}
\DoxyCodeLine{00150         \textcolor{keywordflow}{return} id;}
\DoxyCodeLine{00151     \}}
\DoxyCodeLine{00152     \textcolor{keywordflow}{catch} (std::exception\& e)}
\DoxyCodeLine{00153     \{}
\DoxyCodeLine{00154         std::cerr << e.what() << \textcolor{charliteral}{'\(\backslash\)n'};}
\DoxyCodeLine{00155         \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{00156     \}}
\DoxyCodeLine{00157 \}}
\DoxyCodeLine{00158 }
\DoxyCodeLine{00159 \textcolor{keywordtype}{void} ProcessManager::JobRemove(job\_unit * job)}
\DoxyCodeLine{00160 \{}
\DoxyCodeLine{00161     assert(job-\/>id > 0);}
\DoxyCodeLine{00162     job\_heap-\/>insert(job-\/>id);  \textcolor{comment}{// 将id放回id池中}}
\DoxyCodeLine{00163     jobs.erase(*job);            \textcolor{comment}{// 移出集合}}
\DoxyCodeLine{00164     \textcolor{comment}{// delete job;  // 因为在set里面存放的不是指针了，在erase set的时候已经完成了析构}}
\DoxyCodeLine{00165     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00166 \}}
\DoxyCodeLine{00167 }
\DoxyCodeLine{00168 \textcolor{keywordtype}{void} ProcessManager::JobRemove(std::set<job\_unit>::iterator\& job)}
\DoxyCodeLine{00169 \{}
\DoxyCodeLine{00170     job\_heap-\/>insert(job-\/>id);  \textcolor{comment}{// 将id放回id池中}}
\DoxyCodeLine{00171     jobs.erase(*job);            \textcolor{comment}{// 移出集合}}
\DoxyCodeLine{00172     \textcolor{comment}{// delete job;  // 因为在set里面存放的不是指针了，在erase set的时候已经完成了析构}}
\DoxyCodeLine{00173     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00174 \}}
\DoxyCodeLine{00175 }
\DoxyCodeLine{00176 \textcolor{keywordtype}{int} ProcessManager::ForeGround(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} jobid)}
\DoxyCodeLine{00177 \{}
\DoxyCodeLine{00178     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : jobs)}
\DoxyCodeLine{00179     \{}
\DoxyCodeLine{00180         \textcolor{keywordflow}{if} (job.id == jobid)}
\DoxyCodeLine{00181         \{}
\DoxyCodeLine{00182             Console::child\_process\_id = job.pid;}
\DoxyCodeLine{00183             setpgid(job.pid, getgid());}
\DoxyCodeLine{00184 }
\DoxyCodeLine{00185             \textcolor{comment}{// 将前端设置为子进程}}
\DoxyCodeLine{00186             tcsetpgrp(STDIN\_FILENO, job.pid);}
\DoxyCodeLine{00187             tcsetpgrp(STDOUT\_FILENO, job.pid);}
\DoxyCodeLine{00188             tcsetpgrp(STDERR\_FILENO, job.pid);}
\DoxyCodeLine{00189             job.state = Running;}
\DoxyCodeLine{00190 }
\DoxyCodeLine{00191             kill(job.pid, SIGCONT);}
\DoxyCodeLine{00192             \textcolor{keywordflow}{while}(waitpid(Console::child\_process\_id, NULL, WNOHANG) == 0 \&\& Console::child\_process\_id >= 0);}
\DoxyCodeLine{00193             Console::child\_process\_id = -\/1;}
\DoxyCodeLine{00194 }
\DoxyCodeLine{00195             JobRemove(\&job);}
\DoxyCodeLine{00196 }
\DoxyCodeLine{00197             \textcolor{keywordflow}{return} jobid;}
\DoxyCodeLine{00198         \}}
\DoxyCodeLine{00199     \}}
\DoxyCodeLine{00200 }
\DoxyCodeLine{00201     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00202 \}}
\DoxyCodeLine{00203 }
\DoxyCodeLine{00204 }
\DoxyCodeLine{00205 \textcolor{keywordtype}{int} ProcessManager::BackGround(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} jobid)}
\DoxyCodeLine{00206 \{}
\DoxyCodeLine{00207     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} job : jobs)}
\DoxyCodeLine{00208     \{}
\DoxyCodeLine{00209         \textcolor{keywordflow}{if} (job.id == jobid)}
\DoxyCodeLine{00210         \{}
\DoxyCodeLine{00211             \textcolor{keywordflow}{if} (job.state == Running)}
\DoxyCodeLine{00212                 \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{00213             }
\DoxyCodeLine{00214             job.state = Running;}
\DoxyCodeLine{00215 }
\DoxyCodeLine{00216             kill(job.pid, SIGCONT);}
\DoxyCodeLine{00217             }
\DoxyCodeLine{00218             \textcolor{keywordflow}{return} jobid;}
\DoxyCodeLine{00219         \}}
\DoxyCodeLine{00220     \}}
\DoxyCodeLine{00221 }
\DoxyCodeLine{00222     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00223 \}}

\end{DoxyCode}
