\doxysection{Display.\+cpp}
\label{_display_8cpp_source}\index{src/Display.cpp@{src/Display.cpp}}
\textbf{ 浏览该文件的文档.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001 }
\DoxyCodeLine{00012 \textcolor{preprocessor}{\#include "{}Display.h"{}}}
\DoxyCodeLine{00013 \textcolor{preprocessor}{\#include "{}Console.h"{}}}
\DoxyCodeLine{00014 }
\DoxyCodeLine{00015 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{00016 \textcolor{preprocessor}{\#include <fcntl.h>}}
\DoxyCodeLine{00017 \textcolor{preprocessor}{\#include <string.h>}}
\DoxyCodeLine{00018 \textcolor{preprocessor}{\#include <unistd.h>}}
\DoxyCodeLine{00019 }
\DoxyCodeLine{00020 Display::Display(Console* console)}
\DoxyCodeLine{00021 : console\_(console), perform(true), buffer\_(\textcolor{stringliteral}{"{}"{}})}
\DoxyCodeLine{00022 \{}
\DoxyCodeLine{00023 \}}
\DoxyCodeLine{00024 }
\DoxyCodeLine{00025 Display::\string~Display()}
\DoxyCodeLine{00026 \{}
\DoxyCodeLine{00027 \}}
\DoxyCodeLine{00028 }
\DoxyCodeLine{00029 \textcolor{keywordtype}{int} Display::InputCommand(\textcolor{keywordtype}{char} *input, \textcolor{keyword}{const} \textcolor{keywordtype}{int} len) }
\DoxyCodeLine{00030 \{}
\DoxyCodeLine{00031     tcsetpgrp(STDIN\_FILENO, getpid());}
\DoxyCodeLine{00032     }
\DoxyCodeLine{00033     \textcolor{comment}{// 初始化输入缓冲器与相关变量}}
\DoxyCodeLine{00034     \textcolor{keywordtype}{char} ch;}
\DoxyCodeLine{00035     \textcolor{keywordtype}{int} i = 0;}
\DoxyCodeLine{00036     memset(input, 0, len);}
\DoxyCodeLine{00037 }
\DoxyCodeLine{00038     \textcolor{comment}{// 循环读入字符}}
\DoxyCodeLine{00039     \textcolor{keywordflow}{do}}
\DoxyCodeLine{00040     \{}
\DoxyCodeLine{00041         ssize\_t state = read(console\_-\/>input\_file\_descriptor, \&ch, 1);}
\DoxyCodeLine{00042         \textcolor{keywordflow}{if} (state == 0)}
\DoxyCodeLine{00043         \{}
\DoxyCodeLine{00044             \textcolor{comment}{// 读到了EOF，结束}}
\DoxyCodeLine{00045             \textcolor{keywordflow}{if} (i == 0) \textcolor{comment}{// 如果此时缓冲器中什么内容也没有}}
\DoxyCodeLine{00046                 \textcolor{keywordflow}{return} 0;   \textcolor{comment}{// 直接返回}}
\DoxyCodeLine{00047             \textcolor{keywordflow}{else}    \textcolor{comment}{// 这是文本未加入换行的最后一行}}
\DoxyCodeLine{00048             \{}
\DoxyCodeLine{00049                 input[i++] = \textcolor{charliteral}{'\(\backslash\)n'};  \textcolor{comment}{// 手动加入换行}}
\DoxyCodeLine{00050                 \textcolor{keywordflow}{return} i;           \textcolor{comment}{// 将最后一行命令处理完毕}}
\DoxyCodeLine{00051             \}}
\DoxyCodeLine{00052         \}}
\DoxyCodeLine{00053         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (state == -\/1)}
\DoxyCodeLine{00054         \{}
\DoxyCodeLine{00055             \textcolor{keywordflow}{throw} \textcolor{stringliteral}{"{}Read Input Error"{}};}
\DoxyCodeLine{00056         \}}
\DoxyCodeLine{00057         }
\DoxyCodeLine{00058 }
\DoxyCodeLine{00059         \textcolor{keywordflow}{if} (ch == \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'}) \textcolor{comment}{// 如果读到换行输入\(\backslash\)命令就跳过继续}}
\DoxyCodeLine{00060         \{}
\DoxyCodeLine{00061             ch = getchar(); \textcolor{comment}{// 将随后的换行符读入}}
\DoxyCodeLine{00062             \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00063         \}}
\DoxyCodeLine{00064 }
\DoxyCodeLine{00065         \textcolor{keywordflow}{if} (ch == \textcolor{charliteral}{';'})  \textcolor{comment}{// 将；视为换行符，便于lexer和parser处理}}
\DoxyCodeLine{00066         \{}
\DoxyCodeLine{00067             ch = \textcolor{charliteral}{'\(\backslash\)n'};}
\DoxyCodeLine{00068             perform = \textcolor{keyword}{false};}
\DoxyCodeLine{00069         \}}
\DoxyCodeLine{00070             }
\DoxyCodeLine{00071         input[i++] = ch;}
\DoxyCodeLine{00072 }
\DoxyCodeLine{00073         \textcolor{keywordflow}{if} (i == len)   \textcolor{comment}{// 达到最大长度了}}
\DoxyCodeLine{00074         \{}
\DoxyCodeLine{00075             buffer\_ = \textcolor{stringliteral}{"{}\(\backslash\)e[1;31mERROR\(\backslash\)e[0m input compand exceeds maximum length. 输入命令的长度超过了允许的最大长度"{}};}
\DoxyCodeLine{00076             memset(input, 0, len);  \textcolor{comment}{// 清空缓冲区输入}}
\DoxyCodeLine{00077             \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00078         \}}
\DoxyCodeLine{00079     \} \textcolor{keywordflow}{while} (ch != \textcolor{charliteral}{'\(\backslash\)n'});}
\DoxyCodeLine{00080 }
\DoxyCodeLine{00081 \textcolor{preprocessor}{    \#ifdef \_DEBUG\_}}
\DoxyCodeLine{00082     printf(\textcolor{stringliteral}{"{}input: \%s"{}}, input);}
\DoxyCodeLine{00083 \textcolor{preprocessor}{    \#endif}}
\DoxyCodeLine{00084 }
\DoxyCodeLine{00085     \textcolor{keywordflow}{return} i;}
\DoxyCodeLine{00086 \}}
\DoxyCodeLine{00087 }
\DoxyCodeLine{00088 \textcolor{keywordtype}{void} Display::render()}
\DoxyCodeLine{00089 \{}
\DoxyCodeLine{00090     buffer\_ = \textcolor{stringliteral}{"{}"{}};   \textcolor{comment}{// 每轮循环前将输出缓冲区清空}}
\DoxyCodeLine{00091 }
\DoxyCodeLine{00092     \textcolor{comment}{// 如果不是从标准输入中输入或是不是将内容输出到标准输出的话，}}
\DoxyCodeLine{00093     \textcolor{keywordflow}{if} (console\_-\/>input\_file\_descriptor != STDIN\_FILENO ||}
\DoxyCodeLine{00094         console\_-\/>output\_file\_descriptor != STDOUT\_FILENO)}
\DoxyCodeLine{00095         \textcolor{keywordflow}{return}; \textcolor{comment}{// 就不需要打印提示符}}
\DoxyCodeLine{00096     }
\DoxyCodeLine{00097     \textcolor{keywordflow}{if} (!perform)}
\DoxyCodeLine{00098     \{}
\DoxyCodeLine{00099         perform = \textcolor{keyword}{true};}
\DoxyCodeLine{00100         \textcolor{keywordflow}{return};}
\DoxyCodeLine{00101     \}}
\DoxyCodeLine{00102 }
\DoxyCodeLine{00103     \textcolor{keywordtype}{int} sret = 0;}
\DoxyCodeLine{00104     \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} len = strlen(console\_-\/>home);}
\DoxyCodeLine{00105     \textcolor{keywordflow}{if} (strlen(console\_-\/>current\_working\_dictionary) >= len)}
\DoxyCodeLine{00106     \{}
\DoxyCodeLine{00107         \textcolor{keywordtype}{size\_t} i = 0; }
\DoxyCodeLine{00108         \textcolor{keywordflow}{while} (i < len)}
\DoxyCodeLine{00109         \{}
\DoxyCodeLine{00110             \textcolor{keywordflow}{if} (console\_-\/>current\_working\_dictionary[i] != console\_-\/>home[i])}
\DoxyCodeLine{00111                 \textcolor{keywordflow}{break};}
\DoxyCodeLine{00112             ++i;}
\DoxyCodeLine{00113         \}}
\DoxyCodeLine{00114         \textcolor{keywordflow}{if} (i == len)}
\DoxyCodeLine{00115             sret = i;}
\DoxyCodeLine{00116     \}}
\DoxyCodeLine{00117     }
\DoxyCodeLine{00118     \textcolor{keywordtype}{char} buffer[BUFFER\_SIZE];   \textcolor{comment}{// 打印缓冲区}}
\DoxyCodeLine{00119     sret = sret }
\DoxyCodeLine{00120         ? snprintf(buffer, BUFFER\_SIZE, \textcolor{stringliteral}{"{}\(\backslash\)e[1;32m\%s@\%s\(\backslash\)e[0m:\(\backslash\)e[1;34m\string~\%s\(\backslash\)e[0m> "{}}, \(\backslash\)}
\DoxyCodeLine{00121         console\_-\/>user\_name, console\_-\/>host\_name, console\_-\/>current\_working\_dictionary+sret)}
\DoxyCodeLine{00122         : snprintf(buffer, BUFFER\_SIZE, \textcolor{stringliteral}{"{}\(\backslash\)e[1;32m\%s@\%s\(\backslash\)e[0m:\(\backslash\)e[1;34m\%s\(\backslash\)e[0m> "{}}, \(\backslash\)}
\DoxyCodeLine{00123         console\_-\/>user\_name, console\_-\/>host\_name, console\_-\/>current\_working\_dictionary);}
\DoxyCodeLine{00124     \textcolor{keywordflow}{if} (sret == -\/1)}
\DoxyCodeLine{00125     \{}
\DoxyCodeLine{00126         \textcolor{keywordflow}{throw} \textcolor{stringliteral}{"{}Error when writing into output buffer"{}};}
\DoxyCodeLine{00127     \}}
\DoxyCodeLine{00128 }
\DoxyCodeLine{00129     ssize\_t ret;}
\DoxyCodeLine{00130     ret = write(console\_-\/>output\_file\_descriptor, buffer, strlen(buffer));}
\DoxyCodeLine{00131     \textcolor{keywordflow}{if} (ret == -\/1)}
\DoxyCodeLine{00132     \{}
\DoxyCodeLine{00133         \textcolor{keywordflow}{throw} \textcolor{stringliteral}{"{}Error when writing from buffer"{}};}
\DoxyCodeLine{00134     \}}
\DoxyCodeLine{00135 }
\DoxyCodeLine{00136     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00137 \}}
\DoxyCodeLine{00138 }
\DoxyCodeLine{00139 \textcolor{keywordtype}{void} Display::prompt()\textcolor{keyword}{ const}}
\DoxyCodeLine{00140 \textcolor{keyword}{}\{}
\DoxyCodeLine{00141     \textcolor{keywordflow}{if} (write(console\_-\/>output\_file\_descriptor, \textcolor{stringliteral}{"{}> "{}}, 2) == -\/1)}
\DoxyCodeLine{00142     \{}
\DoxyCodeLine{00143         \textcolor{keywordflow}{throw} std::exception();}
\DoxyCodeLine{00144     \}}
\DoxyCodeLine{00145 \}}
\DoxyCodeLine{00146 }
\DoxyCodeLine{00147 \textcolor{keywordtype}{void} Display::message(\textcolor{keyword}{const} \textcolor{keywordtype}{char} * msg)}
\DoxyCodeLine{00148 \{}
\DoxyCodeLine{00149     buffer\_ += std::string(msg);}
\DoxyCodeLine{00150 \}}
\DoxyCodeLine{00151 }
\DoxyCodeLine{00152 \textcolor{keywordtype}{void} Display::show()\textcolor{keyword}{ const}}
\DoxyCodeLine{00153 \textcolor{keyword}{}\{}
\DoxyCodeLine{00154     ssize\_t ret;}
\DoxyCodeLine{00155     ret = write(console\_-\/>output\_file\_descriptor, buffer\_.c\_str(), buffer\_.length());}
\DoxyCodeLine{00156     \textcolor{keywordflow}{if} (ret == -\/1)}
\DoxyCodeLine{00157     \{}
\DoxyCodeLine{00158         \textcolor{keywordflow}{throw} \textcolor{stringliteral}{"{}Error when showing buffer in Display"{}};}
\DoxyCodeLine{00159     \}}
\DoxyCodeLine{00160 \}}

\end{DoxyCode}
